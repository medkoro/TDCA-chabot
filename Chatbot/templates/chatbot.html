{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alten ChatBot Assistant IA</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="icon" type="image/png" href="{% static 'images/logo-ALTEN.jpg' %}">
    <style>
        /* Styles existants conserv√©s */
        .btn-file {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: none;
            color: #333;
            padding: 15px;
            font-size: 16px;
            transition: all 0.3s ease;
            border-left: 1px solid #FFD700;
        }

        .btn-voice {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: none;
            color: #333;
            padding: 15px;
            font-size: 16px;
            transition: all 0.3s ease;
            border-left: 1px solid #FFD700;
        }

        .btn-file:hover, .btn-voice:hover {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: white;
        }

        .listening {
            animation: pulse 1.5s infinite;
            background: linear-gradient(135deg, #FF4444 0%, #FF0000 100%) !important;
            color: white !important;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 68, 68, 0); }
        }

        body {
            background: linear-gradient(135deg, #2c1810 0%, #1a0f0a 50%, #0f0505 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .chat-container {
            max-width: 800px;
            height: 90vh;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(255, 215, 0, 0.2);
            overflow: hidden;
            position: relative;
            z-index: 10;
            border: 2px solid rgba(255, 215, 0, 0.3);
        }

        .chat-header {
            background: linear-gradient(135deg, #FFFF00 0%, #FF0000 100%);
            color: #333;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .chat-messages {
            height: calc(90vh - 240px);
            overflow-y: auto;
            padding: 20px;
            background: linear-gradient(180deg, #f8f9fa 0%, #ffffff 100%);
        }

        .message {
            margin-bottom: 15px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user { text-align: right; }
        .message.bot { text-align: left; }

        .message-bubble {
            display: inline-block;
            max-width: 75%;
            padding: 12px 18px;
            border-radius: 20px;
            word-wrap: break-word;
            position: relative;
        }

        .message.user .message-bubble {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #333;
            border-bottom-right-radius: 5px;
            font-weight: 500;
        }

        .message.bot .message-bubble {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            color: #333;
            border: 2px solid #FFD700;
            border-bottom-left-radius: 5px;
        }

        .understanding-indicator {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid #FFD700;
            border-radius: 10px;
            padding: 10px;
            margin: 10px 0;
            font-size: 0.9em;
        }

        .intent-badge {
            background: linear-gradient(135deg, #FF4444 0%, #FFD700 100%);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-right: 8px;
        }

        .confidence-bar {
            height: 4px;
            background: #eee;
            border-radius: 2px;
            margin: 5px 0;
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #FF4444, #FFD700);
            transition: width 0.5s ease;
        }

        .form-control {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #FFD700;
            color: #333;
            padding: 15px 20px;
            font-size: 16px;
            border-radius: 25px;
        }

        .btn-send {
            background: linear-gradient(135deg, #FF4444 0%, #FFD700 100%);
            border: none;
            color: white;
            padding: 15px 25px;
            font-size: 16px;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .typing-indicator {
            display: none;
            padding: 10px 0;
        }

        .typing-dots span {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #FFD700;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dots span:nth-child(1) { left: 0; animation-delay: -0.32s; background: #FF4444; }
        .typing-dots span:nth-child(2) { left: 15px; animation-delay: -0.16s; }
        .typing-dots span:nth-child(3) { left: 30px; background: #FF4444; }

        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        .suggestion-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 10px 0;
        }

        .suggestion-chip {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid #FFD700;
            border-radius: 15px;
            padding: 6px 12px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .suggestion-chip:hover {
            background: #FFD700;
            color: #333;
        }

        .ai-analysis {
            background: rgba(68, 68, 255, 0.05);
            border-left: 4px solid #FFD700;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
        }

        .chart-preview {
            text-align: center;
            margin: 15px 0;
            padding: 20px;
            background: rgba(255, 215, 0, 0.05);
            border-radius: 10px;
            border: 1px dashed #FFD700;
        }
    </style>
</head>
<body>
    <!-- File Upload Modal -->
    <div class="modal fade" id="fileUploadModal" tabindex="-1" aria-labelledby="fileUploadModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="fileUploadModalLabel">Upload Excel File</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="excelUploadForm">
                        <div class="mb-3">
                            <label for="excelFile" class="form-label">Choose Excel File</label>
                            <input class="form-control" type="file" id="excelFile" accept=".xlsx,.xls,.xlsm" required>
                        </div>
                        <div class="d-flex justify-content-end">
                            <button type="submit" class="btn btn-primary">Upload</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid d-flex justify-content-center align-items-center min-vh-100 p-3">
        <div class="chat-container">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center p-3" style="background: linear-gradient(135deg, #FFFF00 0%, #FF0000 100%);">
                <div>
                    <h3 class="m-0">
                        <span class="alten-logo">ALTEN</span>
                        <i class="fas fa-brain ms-2"></i> 
                        Assistant IA Avanc√©
                        <span class="online-indicator"></span>
                    </h3>
                    <small>Intelligence Artificielle ‚Ä¢ Analyse de Donn√©es ‚Ä¢ Visualisation</small>
                </div>
                <div class="d-flex flex-column align-items-end">
                    <button class="btn btn-sm btn-outline-dark mb-2" data-bs-toggle="modal" data-bs-target="#fileUploadModal">
                        <i class="fas fa-file-excel me-1"></i> Charger Excel
                    </button>
                    <div id="fileInfo" class="small text-end" style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                        Aucun fichier charg√©
                    </div>
                </div>
            </div>
            
            <!-- Messages -->
            <div class="chat-messages" id="chatMessages">
                <div class="message bot">
                    <div class="message-bubble">
                        <i class="fas fa-robot" style="color: #FFD700;"></i> 
                        Bonjour ! Je suis votre assistant IA ALTEN avec compr√©hension naturelle du langage. 
                        Je peux analyser vos demandes et cr√©er des graphiques personnalis√©s. 
                        <br><br>
                        <strong>Essayez de me dire quelque chose comme :</strong>
                        <div class="suggestion-chips">
                            <span class="suggestion-chip" onclick="sendMessage('Je veux un graphique en barres des ventes par mois')">üìä Graphique des ventes</span>
                            <span class="suggestion-chip" onclick="sendMessage('Cr√©er un rapport sur les performances')">üìà Rapport de performance</span>
                            <span class="suggestion-chip" onclick="sendMessage('Analyser les donn√©es de production')">üîç Analyse production</span>
                        </div>
                    </div>
                    <div class="message-time">Maintenant</div>
                </div>
            </div>
            
            <!-- Typing Indicator -->
            <div class="typing-indicator" id="typingIndicator">
                <div style="position: relative; display: inline-block; width: 60px; height: 20px;">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                <small class="text-muted ms-3">L'IA ALTEN analyse votre demande...</small>
            </div>
            
            <!-- Input -->
            <div class="chat-input-container" style="padding: 20px; background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%); border-top: 2px solid #FFD700;">
                <div class="input-group" style="border-radius: 25px; overflow: hidden; box-shadow: 0 4px 20px rgba(255, 215, 0, 0.2); border: 2px solid #FFD700;">
                    <input type="text" class="form-control" id="messageInput" placeholder="Dites-moi ce que vous voulez faire (ex: cr√©er un graphique, analyser des donn√©es...)" onkeypress="handleKeyPress(event)">
                    
                    <button class="btn btn-voice" id="voiceButton">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <button class="btn btn-send" onclick="processUserMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Global variables
        let currentFile = null;
        let currentSheet = null;
        let sheetData = {};
        let currentData = null;

        // DOM Elements
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const typingIndicator = document.getElementById('typingIndicator');
        const fileInfo = document.getElementById('fileInfo');
        const excelUploadForm = document.getElementById('excelUploadForm');
        const excelFileInput = document.getElementById('excelFile');

        // Event Listeners
document.addEventListener('DOMContentLoaded', function() {
    // Initialize tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function(tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Handle Excel file upload
    if (excelUploadForm) {
        excelUploadForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!excelFileInput.files || excelFileInput.files.length === 0) {
                showError('Veuillez s√©lectionner un fichier Excel');
                return;
            }

            const file = excelFileInput.files[0];
            const formData = new FormData();
            formData.append('excel_file', file);

            try {
                showLoading(true, 'Traitement du fichier Excel...');
                
                const response = await fetch('/upload-excel/', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFTTOKEN': getCookie('csrftoken')
                    }
                });

                const data = await response.json();
                
                if (data.status === 'success') {
                    currentFile = file;
                    fileInfo.textContent = file.name;
                    fileInfo.title = file.name;
                    
                    // Store sheet data
                    sheetData = data.sheet_data || {};
                    
                    // Load first sheet by default
                    if (data.sheet_names && data.sheet_names.length > 0) {
                        loadSheetData(data.sheet_names[0]);
                    }
                    
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('fileUploadModal'));
                    modal.hide();
                    
                    // Show success message
                    addMessage(`Fichier "${file.name}" charg√© avec succ√®s !`, false);
                } else {
                    throw new Error(data.message || 'Erreur lors du chargement du fichier');
                }
            } catch (error) {
                console.error('Error uploading file:', error);
                showError(`Erreur: ${error.message}`);
            } finally {
                showLoading(false);
            }
        });
    }
});

// Helper function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Load sheet data
async function loadSheetData(sheetName) {
    try {
        showLoading(true, `Chargement de la feuille "${sheetName}"...`);
        
        const response = await fetch(`/sheet-data/${encodeURIComponent(sheetName)}/`);
        const data = await response.json();
        
        if (data.status === 'success') {
            currentSheet = sheetName;
            currentData = data.data;
            
            // Update UI with data
            updateDataDisplay();
        } else {
            throw new Error(data.message || 'Erreur lors du chargement des donn√©es');
        }
    } catch (error) {
        console.error('Error loading sheet data:', error);
        showError(`Erreur: ${error.message}`);
    } finally {
        showLoading(false);
    }
}

// Update data display
function updateDataDisplay() {
    if (!currentData || !currentData.columns || !currentData.rows) {
        return;
    }

    // Create a preview of the data
    let preview = '<div class="table-responsive mt-3">';
    preview += '<table class="table table-sm table-bordered table-hover">';
    
    // Add header row
    preview += '<thead class="table-light"><tr>';
    currentData.columns.forEach(column => {
        preview += `<th>${column}</th>`;
    });
    preview += '</tr></thead>';
    
    // Add data rows (limit to 5 for preview)
    preview += '<tbody>';
    const rowCount = Math.min(5, currentData.rows.length);
    for (let i = 0; i < rowCount; i++) {
        preview += '<tr>';
        currentData.rows[i].forEach(cell => {
            preview += `<td>${cell !== null ? cell : ''}</td>`;
        });
        preview += '</tr>';
    }
    
    if (currentData.rows.length > 5) {
        preview += `<tr><td colspan="${currentData.columns.length}" class="text-center text-muted">... et ${currentData.rows.length - 5} lignes suppl√©mentaires</td></tr>`;
    }
    
    preview += '</tbody></table></div>';
    
    // Add data summary
    preview += `<div class="alert alert-info mt-2">
        <i class="fas fa-info-circle me-2"></i>
        ${currentData.rows.length} lignes √ó ${currentData.columns.length} colonnes
    </div>`;
    
    // Add to chat
    addMessage(`Donn√©es de la feuille "${currentSheet}" charg√©es avec succ√®s :`, false);
    
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message bot';
    messageDiv.innerHTML = `
        <div class="message-bubble">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <strong>${currentFile.name} - ${currentSheet}</strong>
                <div>
                    <button class="btn btn-sm btn-outline-primary me-1" onclick="showFullData()">
                        <i class="fas fa-expand"></i> Voir tout
                    </button>
                    <button class="btn btn-sm btn-outline-success" onclick="analyzeData()">
                        <i class="fas fa-chart-line"></i> Analyser
                    </button>
                </div>
            </div>
            ${preview}
        </div>
    `;
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Show loading indicator
function showLoading(show, message = 'Chargement...') {
    if (show) {
        // Show loading indicator
        const loadingDiv = document.createElement('div');
        loadingDiv.id = 'loadingIndicator';
        loadingDiv.className = 'message bot';
        loadingDiv.innerHTML = `
            <div class="message-bubble">
                <div class="d-flex align-items-center">
                    <div class="spinner-border spinner-border-sm text-warning me-2" role="status">
                        <span class="visually-hidden">Chargement...</span>
                    </div>
                    ${message}
                </div>
            </div>
        `;
        chatMessages.appendChild(loadingDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    } else {
        // Remove loading indicator
        const loadingDiv = document.getElementById('loadingIndicator');
        if (loadingDiv) {
            loadingDiv.remove();
        }
    }
}

// Show error message
function showError(message) {
    const errorDiv = document.createElement('div');
    errorDiv.className = 'message bot';
    errorDiv.innerHTML = `
        <div class="message-bubble">
            <div class="alert alert-danger mb-0">
                <i class="fas fa-exclamation-triangle me-2"></i>
                ${message}
            </div>
        </div>
    `;
    chatMessages.appendChild(errorDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}
        // Syst√®me de compr√©hension IA am√©lior√©
        const intentPatterns = {
            'graphique': {
                keywords: ['graphique', 'graphe', 'chart', 'diagramme', 'visualisation', 'courbe', 'barres', 'secteur', 'histogramme'],
                types: ['barres', 'courbe', 'secteur', 'radar', 'histogramme', 'scatter', 'line'],
                response: "Je comprends que vous voulez cr√©er un graphique"
            },
            'rapport': {
                keywords: ['rapport', 'report', 'analyse', 'synth√®se', 'r√©sum√©', 'dashboard', 'tableau de bord'],
                response: "Je vais g√©n√©rer un rapport d'analyse"
            },
            'donn√©es': {
                keywords: ['donn√©es', 'data', 'informations', 'chiffres', 'statistiques', 'metrics', 'kpi'],
                response: "Je vais analyser vos donn√©es"
            },
            'performance': {
                keywords: ['performance', 'rendement', 'efficacit√©', 'productivit√©', 'r√©sultats', 'metrics'],
                response: "Analysons les performances"
            },
            'ventes': {
                keywords: ['ventes', 'chiffre d\'affaires', 'ca', 'revenus', 'commercial', 'clients'],
                response: "Analyse des donn√©es de vente"
            },
            'production': {
                keywords: ['production', 'fabrication', 'manufacturing', 'usine', 'qualit√©', 'd√©fauts'],
                response: "Analyse de la production"
            }
        };

        function analyzeIntent(message) {
            const lowerMessage = message.toLowerCase();
            let bestMatch = { intent: 'g√©n√©ral', confidence: 0, details: {} };
            
            for (const [intent, config] of Object.entries(intentPatterns)) {
                let confidence = 0;
                let matchedKeywords = [];
                
                // V√©rifier les mots-cl√©s principaux
                for (const keyword of config.keywords) {
                    if (lowerMessage.includes(keyword)) {
                        confidence += 0.3;
                        matchedKeywords.push(keyword);
                    }
                }
                
                // Bonus pour les types sp√©cifiques (graphiques)
                if (config.types) {
                    for (const type of config.types) {
                        if (lowerMessage.includes(type)) {
                            confidence += 0.4;
                            bestMatch.details.chartType = type;
                        }
                    }
                }
                
                // Recherche de p√©riodes temporelles
                const timePatterns = ['mois', 'ann√©e', 'jour', 'semaine', 'trimestre', 'mensuel', 'annuel'];
                for (const period of timePatterns) {
                    if (lowerMessage.includes(period)) {
                        confidence += 0.2;
                        bestMatch.details.timePeriod = period;
                    }
                }
                
                if (confidence > bestMatch.confidence) {
                    bestMatch = {
                        intent,
                        confidence: Math.min(confidence, 1.0),
                        response: config.response,
                        matchedKeywords,
                        details: bestMatch.details
                    };
                }
            }
            
            return bestMatch;
        }

        function generateIntelligentResponse(analysis, originalMessage) {
            let response = `<div class="ai-analysis">`;
            response += `<strong><i class="fas fa-brain"></i> Analyse IA :</strong><br>`;
            response += `<span class="intent-badge">${analysis.intent.toUpperCase()}</span>`;
            response += `${analysis.response}<br>`;
            
            // Barre de confiance
            response += `<div class="confidence-bar">`;
            response += `<div class="confidence-fill" style="width: ${analysis.confidence * 100}%"></div>`;
            response += `</div>`;
            response += `<small>Confiance: ${Math.round(analysis.confidence * 100)}%</small>`;
            
            if (analysis.matchedKeywords.length > 0) {
                response += `<br><small><strong>Mots-cl√©s d√©tect√©s:</strong> ${analysis.matchedKeywords.join(', ')}</small>`;
            }
            
            response += `</div>`;
            
            // R√©ponse personnalis√©e selon l'intention
            switch (analysis.intent) {
                case 'graphique':
                    response += `<div class="chart-preview">`;
                    response += `<i class="fas fa-chart-${analysis.details.chartType === 'barres' ? 'bar' : 'line'} fa-3x" style="color: #FFD700;"></i><br>`;
                    response += `<strong>Graphique ${analysis.details.chartType || 'personnalis√©'}</strong><br>`;
                    if (analysis.details.timePeriod) {
                        response += `<small>P√©riode: ${analysis.details.timePeriod}</small><br>`;
                    }
                    if (selectedFile) {
                        response += `<small class="text-success">‚úì Fichier pr√™t: ${selectedFile.name}</small><br>`;
                        response += `<button class="btn btn-sm btn-primary mt-2" onclick="generateChart('${analysis.details.chartType || 'auto'}')">`;
                        response += `<i class="fas fa-magic"></i> G√©n√©rer le graphique`;
                        response += `</button>`;
                    } else {
                        response += `<small class="text-warning">‚ö†Ô∏è Veuillez d'abord uploader un fichier de donn√©es</small>`;
                    }
                    response += `</div>`;
                    break;
                    
                case 'rapport':
                    response += `<div class="chart-preview">`;
                    response += `<i class="fas fa-file-chart fa-3x" style="color: #FF4444;"></i><br>`;
                    response += `<strong>Rapport d'analyse</strong><br>`;
                    if (selectedFile) {
                        response += `<small class="text-success">‚úì Donn√©es disponibles</small><br>`;
                        response += `<button class="btn btn-sm btn-success mt-2" onclick="generateReport()">`;
                        response += `<i class="fas fa-file-alt"></i> Cr√©er le rapport`;
                        response += `</button>`;
                    } else {
                        response += `<small class="text-warning">‚ö†Ô∏è Ajoutez des donn√©es pour g√©n√©rer le rapport</small>`;
                    }
                    response += `</div>`;
                    break;
                    
                default:
                    response += `<div class="suggestion-chips">`;
                    response += `<span class="suggestion-chip" onclick="sendMessage('Cr√©er un graphique en barres')">üìä Graphique</span>`;
                    response += `<span class="suggestion-chip" onclick="sendMessage('G√©n√©rer un rapport')">üìÑ Rapport</span>`;
                    response += `<span class="suggestion-chip" onclick="sendMessage('Analyser les donn√©es')">üîç Analyse</span>`;
                    response += `</div>`;
            }
            
            // Suggestions contextuelles
            response += `<br><div class="understanding-indicator">`;
            response += `<small><strong>üí° Suggestions :</strong><br>`;
            response += `‚Ä¢ Soyez plus pr√©cis sur le type de graphique (barres, courbe, secteur)<br>`;
            response += `‚Ä¢ Mentionnez la p√©riode d'analyse (mensuel, annuel)<br>`;
            response += `‚Ä¢ Indiquez les variables √† analyser</small>`;
            response += `</div>`;
            
            return response;
        }

        function addMessage(text, isUser = false, showAnalysis = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'bot'}`;
            
            messageDiv.innerHTML = `
                <div class="message-bubble">
                    ${text}
                </div>
                <div class="message-time">${getCurrentTime()}</div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function getCurrentTime() {
            return new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
        }

        function showTyping() {
            typingIndicator.style.display = 'block';
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function hideTyping() {
            typingIndicator.style.display = 'none';
        }

        function processUserMessage() {
            const message = messageInput.value.trim();
            if (!message) return;

            addMessage(message, true);
            messageInput.value = '';
            showTyping();

            // Appel √† l‚ÄôAPI Django/LangChain
            fetch('/Alten/Chatbot/analyze/', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: 'text=' + encodeURIComponent(message)
            })
            .then(response => response.json())
            .then(data => {
                hideTyping();
                if (data.result) {
                    addMessage(`<strong>ChatBot Alten :</strong><br>${data.result}`);
                } else if (data.error) {
                    addMessage(`‚ùå Erreur d'analyse :<br><span style='color:red'>${data.error}</span> recharger la page svp`);
                } else {
                    addMessage("‚ùå Erreur d'analyse inconnue. rechargez la page svp");
                }
            })
            .catch(() => {
                hideTyping();
                addMessage("‚ùå Erreur de connexion au serveur.");
            });
        }

        function sendMessage(text) {
            messageInput.value = text;
            processUserMessage();
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                processUserMessage();
            }
        }

        
     
        function generateChart(type) {
            if (!selectedFile) {
                addMessage("‚ùå Aucun fichier s√©lectionn√© pour g√©n√©rer le graphique.");
                return;
            }
            
            showTyping();
            addMessage(`üöÄ G√©n√©ration du graphique ${type} en cours...`, true);
            
            // Simulation de g√©n√©ration
            setTimeout(() => {
                hideTyping();
                addMessage(`‚úÖ <strong>Graphique g√©n√©r√© avec succ√®s!</strong><br>
                    <div class="chart-preview">
                        <i class="fas fa-chart-bar fa-4x" style="color: #FFD700;"></i><br>
                        <strong>Graphique ${type}</strong><br>
                        <small>Bas√© sur: ${selectedFile.name}</small><br>
                        <button class="btn btn-sm btn-outline-primary mt-2">
                            <i class="fas fa-download"></i> T√©l√©charger
                        </button>
                    </div>`);
            }, 2000);
        }

        function generateReport() {
            if (!selectedFile) {
                addMessage("‚ùå Aucun fichier s√©lectionn√© pour g√©n√©rer le rapport.");
                return;
            }
            
            showTyping();
            addMessage("üìä G√©n√©ration du rapport d'analyse...", true);
            
            setTimeout(() => {
                hideTyping();
                addMessage(`üìã <strong>Rapport g√©n√©r√©!</strong><br>
                    <div class="ai-analysis">
                        <strong>R√©sum√© ex√©cutif:</strong><br>
                        ‚Ä¢ ${Math.floor(Math.random() * 1000 + 500)} lignes de donn√©es analys√©es<br>
                        ‚Ä¢ ${Math.floor(Math.random() * 20 + 5)} variables identifi√©es<br>
                        ‚Ä¢ Tendances positives d√©tect√©es<br>
                        ‚Ä¢ Recommandations g√©n√©r√©es<br><br>
                        <button class="btn btn-sm btn-success">
                            <i class="fas fa-file-pdf"></i> T√©l√©charger PDF
                        </button>
                    </div>`);
            }, 3000);
        }

        // Reconnaissance vocale am√©lior√©e avec gestion d'erreurs
        function setupVoiceRecognition() {
            const voiceButton = document.getElementById('voiceButton');
            
            // V√©rifier le support de la reconnaissance vocale
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                voiceButton.disabled = true;
                voiceButton.title = "Reconnaissance vocale non support√©e par ce navigateur";
                voiceButton.innerHTML = '<i class="fas fa-microphone-slash"></i>';
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new SpeechRecognition();
            
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'fr-FR';
            recognition.maxAlternatives = 1;

            let isListening = false;

            voiceButton.addEventListener('click', async () => {
                // Arr√™ter si d√©j√† en √©coute
                if (isListening) {
                    recognition.stop();
                    return;
                }

                try {
                    // Demander permission microphone explicitement
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    stream.getTracks().forEach(track => track.stop()); // Arr√™ter le stream de test
                    
                    // D√©marrer la reconnaissance
                    recognition.start();
                    isListening = true;
                    voiceButton.classList.add('listening');
                    messageInput.placeholder = "üé§ √âcoute en cours... Parlez maintenant!";
                    
                    // Afficher message d'√©coute
                    addMessage("üé§ <em>Microphone activ√© - Parlez clairement...</em>");
                    
                } catch (error) {
                    console.error('Erreur microphone:', error);
                    let errorMessage = "‚ùå ";
                    
                    if (error.name === 'NotAllowedError') {
                        errorMessage += "Permission microphone refus√©e. Veuillez autoriser l'acc√®s au microphone dans les param√®tres de votre navigateur.";
                    } else if (error.name === 'NotFoundError') {
                        errorMessage += "Aucun microphone d√©tect√©. V√©rifiez votre mat√©riel audio.";
                    } else {
                        errorMessage += `Erreur microphone: ${error.message}`;
                    }
                    
                    addMessage(errorMessage);
                    
                    // D√©sactiver temporairement le bouton
                    voiceButton.disabled = true;
                    setTimeout(() => {
                        voiceButton.disabled = false;
                    }, 3000);
                }
            });

            recognition.onstart = () => {
                console.log('Reconnaissance vocale d√©marr√©e');
                voiceButton.innerHTML = '<i class="fas fa-stop"></i>';
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                const confidence = event.results[0][0].confidence;
                
                messageInput.value = transcript;
                messageInput.placeholder = "Dites-moi ce que vous voulez faire...";
                
                // Afficher le r√©sultat avec score de confiance
                const confidencePercent = Math.round(confidence * 100);
                addMessage(`üé§ <strong>Reconnaissance vocale</strong> (${confidencePercent}% confiance):<br>"${transcript}"`, true);
                
                // Auto-traitement si confiance √©lev√©e
                if (confidence > 0.7) {
                    setTimeout(() => processUserMessage(), 800);
                } else {
                    addMessage("ü§î <em>Confiance faible. Voulez-vous reformuler ou corriger le texte?</em>");
                }
            };

            recognition.onspeechstart = () => {
                addMessage("üó£Ô∏è <em>Parole d√©tect√©e...</em>");
            };

            recognition.onspeechend = () => {
                addMessage("‚úÖ <em>Fin de parole d√©tect√©e</em>");
            };

            recognition.onerror = (event) => {
                console.error('Erreur reconnaissance vocale:', event.error);
                isListening = false;
                voiceButton.classList.remove('listening');
                voiceButton.innerHTML = '<i class="fas fa-microphone"></i>';
                messageInput.placeholder = "Dites-moi ce que vous voulez faire...";
                
                let errorMessage = "‚ùå ";
                
                switch (event.error) {
                    case 'not-allowed':
                        errorMessage += "<strong>Permission refus√©e</strong><br>Veuillez autoriser l'acc√®s au microphone:<br>";
                        errorMessage += "‚Ä¢ Chrome: Cliquez sur l'ic√¥ne üîí dans la barre d'adresse<br>";
                        errorMessage += "‚Ä¢ Firefox: Cliquez sur l'ic√¥ne microphone dans la barre d'adresse<br>";
                        errorMessage += "‚Ä¢ Ou rechargez la page et autorisez quand demand√©";
                        break;
                    case 'no-speech':
                        errorMessage += "Aucune parole d√©tect√©e. Rapprochez-vous du microphone et parlez plus fort.";
                        break;
                    case 'audio-capture':
                        errorMessage += "Microphone non accessible. V√©rifiez que votre microphone est connect√© et fonctionnel.";
                        break;
                    case 'network':
                        errorMessage += "Erreur r√©seau. V√©rifiez votre connexion internet.";
                        break;
                    case 'service-not-allowed':
                        errorMessage += "Service de reconnaissance non autoris√©. Utilisez HTTPS ou localhost.";
                        break;
                    default:
                        errorMessage += `Erreur technique: ${event.error}`;
                }
                
                addMessage(errorMessage);
            };

            recognition.onend = () => {
                console.log('Reconnaissance vocale termin√©e');
                isListening = false;
                voiceButton.classList.remove('listening');
                voiceButton.innerHTML = '<i class="fas fa-microphone"></i>';
                messageInput.placeholder = "Dites-moi ce que vous voulez faire...";
            };

            // V√©rifier les permissions au chargement
            navigator.permissions.query({name: 'microphone'}).then((result) => {
                if (result.state === 'denied') {
                    voiceButton.style.opacity = '0.5';
                    voiceButton.title = "Permission microphone requise";
                } else if (result.state === 'granted') {
                    voiceButton.title = "Cliquez pour activer la reconnaissance vocale";
                }
                
                result.onchange = () => {
                    if (result.state === 'granted') {
                        voiceButton.style.opacity = '1';
                        voiceButton.title = "Cliquez pour activer la reconnaissance vocale";
                    }
                };
            }).catch(() => {
                // Permissions API non support√©e
                voiceButton.title = "Cliquez pour activer la reconnaissance vocale";
            });
        }

        // Initialisation
        messageInput.focus();
        setupVoiceRecognition();

        // Messages de bienvenue avec instructions microphone
        setTimeout(() => {
            addMessage(`üí° <strong>Test de compr√©hension:</strong> Essayez de dire quelque chose comme:<br>
                ‚Ä¢ "Je veux cr√©er un graphique en barres des ventes par mois"<br>
                ‚Ä¢ "Fais-moi un rapport sur les performances"<br>
                ‚Ä¢ "Analyse mes donn√©es de production"<br><br>
                üé§ <strong>Pour la reconnaissance vocale:</strong><br>
                ‚Ä¢ Autorisez l'acc√®s au microphone quand demand√©<br>
                ‚Ä¢ Utilisez HTTPS ou localhost (requis par les navigateurs)<br>
                ‚Ä¢ Parlez clairement apr√®s avoir cliqu√© sur <i class="fas fa-microphone"></i><br><br>
                L'IA va analyser votre demande et vous proposer des solutions personnalis√©es!`);
        }, 2000);

        // V√©rifier si on est sur HTTPS ou localhost
        setTimeout(() => {
            if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                addMessage(`‚ö†Ô∏è <strong>Information importante:</strong><br>
                    La reconnaissance vocale n√©cessite HTTPS ou localhost pour des raisons de s√©curit√©.<br>
                    Actuellement sur: <code>${location.protocol}//${location.hostname}</code><br>
                    Vous pouvez toujours utiliser la saisie manuelle! üìù`);
            }
        }, 4000);

        // Show full data in a modal
        function showFullData() {
            if (!currentData || !currentData.columns || !currentData.rows) {
                showError('Aucune donn√©e √† afficher');
                return;
            }

            // Create modal HTML
            const modalId = 'dataModal';
            let modalHtml = `
            <div class="modal fade" id="${modalId}" tabindex="-1" aria-labelledby="dataModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="dataModalLabel">
                                <i class="fas fa-table me-2"></i>
                                ${currentFile.name} - ${currentSheet}
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered table-hover">
                                    <thead class="table-light">
                                        <tr>
            `;

            // Add headers
            currentData.columns.forEach(column => {
                modalHtml += `<th>${column}</th>`;
            });
            
            modalHtml += `
                                        </tr>
                                    </thead>
                                    <tbody>
            `;
            
            // Add data rows
            currentData.rows.forEach(row => {
                modalHtml += '<tr>';
                row.forEach(cell => {
                    modalHtml += `<td>${cell !== null ? cell : ''}</td>`;
                });
                modalHtml += '</tr>';
            });
            
            modalHtml += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                            <button type="button" class="btn btn-primary" onclick="exportToExcel()">
                                <i class="fas fa-file-export me-1"></i> Exporter vers Excel
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            `;
            
            // Add modal to the page
            const modalContainer = document.createElement('div');
            modalContainer.innerHTML = modalHtml;
            document.body.appendChild(modalContainer);
            
            // Show the modal
            const modal = new bootstrap.Modal(document.getElementById(modalId));
            modal.show();
            
            // Clean up the modal when it's hidden
            document.getElementById(modalId).addEventListener('hidden.bs.modal', function () {
                modalContainer.remove();
            });
        }

        // Analyze the current data
        function analyzeData() {
            if (!currentData || !currentData.columns || !currentData.rows) {
                showError('Aucune donn√©e √† analyser');
                return;
            }
            
            // Show loading indicator
            showLoading(true, 'Analyse des donn√©es en cours...');
            
            // Simulate analysis (in a real app, this would be an API call)
            setTimeout(() => {
                showLoading(false);
                
                // Create a simple analysis report
                const analysis = {
                    rowCount: currentData.rows.length,
                    columnCount: currentData.columns.length,
                    numericColumns: [],
                    textColumns: [],
                    dateColumns: [],
                    columnStats: {}
                };
                
                // Analyze each column
                currentData.columns.forEach((col, colIndex) => {
                    const values = currentData.rows.map(row => row[colIndex]);
                    const nonEmptyValues = values.filter(v => v !== null && v !== '');
                    const numericValues = nonEmptyValues.filter(v => !isNaN(parseFloat(v)));
                    
                    const colStats = {
                        name: col,
                        nonEmptyCount: nonEmptyValues.length,
                        emptyCount: values.length - nonEmptyValues.length,
                        isNumeric: numericValues.length > 0,
                        uniqueValues: [...new Set(nonEmptyValues)].length
                    };
                    
                    if (colStats.isNumeric) {
                        colStats.min = Math.min(...numericValues);
                        colStats.max = Math.max(...numericValues);
                        colStats.avg = numericValues.reduce((a, b) => a + parseFloat(b), 0) / numericValues.length;
                        analysis.numericColumns.push(col);
                    } else if (nonEmptyValues.length > 0) {
                        // Try to detect dates
                        const dateCount = nonEmptyValues.filter(v => {
                            return !isNaN(Date.parse(v)) && v.toString().match(/\d{4}-\d{2}-\d{2}/);
                        }).length;
                        
                        if (dateCount / nonEmptyValues.length > 0.5) {
                            analysis.dateColumns.push(col);
                            colStats.isDate = true;
                        } else {
                            analysis.textColumns.push(col);
                        }
                    }
                    
                    analysis.columnStats[col] = colStats;
                });
                
                // Display the analysis
                displayAnalysis(analysis);
            }, 1500);
        }

        // Display data analysis results
        function displayAnalysis(analysis) {
            let html = `
                <div class="message-bubble">
                    <h5><i class="fas fa-chart-pie me-2"></i> Analyse des donn√©es</h5>
                    <div class="alert alert-info">
                        <div class="d-flex justify-content-between">
                            <div><i class="fas fa-table me-2"></i> ${analysis.rowCount} lignes √ó ${analysis.columnCount} colonnes</div>
                            <div><i class="fas fa-chart-bar me-2"></i> ${analysis.numericColumns.length} colonnes num√©riques</div>
                            <div><i class="fas fa-font me-2"></i> ${analysis.textColumns.length} colonnes texte</div>
                        </div>
                    </div>
                    <div class="row mt-3">
            `;
            
            // Add a card for each column
            currentData.columns.forEach(column => {
                const stats = analysis.columnStats[column];
                
                html += `
                    <div class="col-md-6 mb-3">
                        <div class="card h-100">
                            <div class="card-header bg-light">
                                <strong>${column}</strong>
                                ${stats.isNumeric ? '<span class="badge bg-primary ms-2">Num√©rique</span>' : ''}
                                ${stats.isDate ? '<span class="badge bg-success ms-2">Date</span>' : ''}
                                ${!stats.isNumeric && !stats.isDate ? '<span class="badge bg-secondary ms-2">Texte</span>' : ''}
                            </div>
                            <div class="card-body">
                                <div class="mb-2">
                                    <small class="text-muted">Valeurs non vides:</small>
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar bg-success" role="progressbar" 
                                             style="width: ${(stats.nonEmptyCount / currentData.rows.length) * 100}%" 
                                             aria-valuenow="${stats.nonEmptyCount}" 
                                             aria-valuemin="0" 
                                             aria-valuemax="${currentData.rows.length}">
                                            ${stats.nonEmptyCount} / ${currentData.rows.length}
                                        </div>
                                    </div>
                                </div>
                                ${stats.isNumeric ? `
                                    <div class="row">
                                        <div class="col-4">
                                            <small class="text-muted">Min</small>
                                            <div class="fw-bold">${stats.min.toLocaleString()}</div>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted">Moyenne</small>
                                            <div class="fw-bold">${stats.avg.toFixed(2)}</div>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted">Max</small>
                                            <div class="fw-bold">${stats.max.toLocaleString()}</div>
                                        </div>
                                    </div>
                                ` : ''}
                                <div class="mt-2">
                                    <small class="text-muted">Valeurs uniques:</small>
                                    <div class="fw-bold">${stats.uniqueValues}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += `
                    </div>
                    <div class="text-end mt-3">
                        <button class="btn btn-sm btn-outline-primary me-2" onclick="suggestVisualizations(${JSON.stringify(analysis).replace(/"/g, '&quot;')})">
                            <i class="fas fa-magic me-1"></i> Suggestions de visualisations
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="$('#dataAnalysis').remove()">
                            <i class="fas fa-times me-1"></i> Fermer
                        </button>
                    </div>
                </div>
            `;
            
            // Add to chat
            const analysisDiv = document.createElement('div');
            analysisDiv.id = 'dataAnalysis';
            analysisDiv.className = 'message bot';
            analysisDiv.innerHTML = html;
            chatMessages.appendChild(analysisDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Suggest visualizations based on data analysis
        function suggestVisualizations(analysis) {
            let suggestions = [];
            
            // Time series suggestions
            if (analysis.dateColumns.length > 0) {
                analysis.numericColumns.forEach(numCol => {
                    suggestions.push({
                        title: `S√©rie temporelle de ${numCol}`,
                        type: 'line',
                        xAxis: analysis.dateColumns[0],
                        yAxis: numCol,
                        description: `Montre l'√©volution de ${numCol} au fil du temps.`
                    });
                });
            }
            
            // Bar chart suggestions for categorical data
            if (analysis.textColumns.length > 0) {
                analysis.numericColumns.forEach(numCol => {
                    analysis.textColumns.forEach(textCol => {
                        if (analysis.columnStats[textCol].uniqueValues < 20) {
                            suggestions.push({
                                title: `${numCol} par ${textCol}`,
                                type: 'bar',
                                xAxis: textCol,
                                yAxis: numCol,
                                description: `Compare les valeurs de ${numCol} par cat√©gorie de ${textCol}.`
                            });
                        }
                    });
                });
            }
            
            // Pie chart for distribution
            if (analysis.textColumns.some(col => analysis.columnStats[col].uniqueValues < 10)) {
                const catCol = analysis.textColumns.find(col => analysis.columnStats[col].uniqueValues < 10);
                if (catCol) {
                    suggestions.push({
                        title: `R√©partition par ${catCol}`,
                        type: 'pie',
                        xAxis: catCol,
                        description: `Affiche la r√©partition des donn√©es par ${catCol}.`
                    });
                }
            }
            
            // Display suggestions
            let html = `
                <div class="message-bubble">
                    <h5><i class="fas fa-lightbulb me-2"></i> Suggestions de visualisations</h5>
                    <div class="row">
            `;
            
            suggestions.forEach((suggestion, index) => {
                const icon = suggestion.type === 'line' ? 'chart-line' : 
                            suggestion.type === 'bar' ? 'chart-bar' : 'chart-pie';
                
                html += `
                    <div class="col-md-6 mb-3">
                        <div class="card h-100">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="fas ${icon} me-2"></i>
                                    ${suggestion.title}
                                </div>
                                <button class="btn btn-sm btn-outline-primary" 
                                        onclick="createChart(${JSON.stringify(suggestion).replace(/"/g, '&quot;')})">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                            <div class="card-body">
                                <p class="card-text small">${suggestion.description}</p>
                                <div class="text-muted small">
                                    Type: ${suggestion.type}
                                    ${suggestion.xAxis ? `<br>X: ${suggestion.xAxis}` : ''}
                                    ${suggestion.yAxis ? `<br>Y: ${suggestion.yAxis}` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            if (suggestions.length === 0) {
                html += `
                    <div class="col-12">
                        <div class="alert alert-info text-center">
                            <i class="fas fa-info-circle me-2"></i>
                            Aucune suggestion de visualisation disponible pour ces donn√©es.
                        </div>
                    </div>
                `;
            }
            
            html += `
                    </div>
                </div>
            `;
            
            // Add to chat
            const suggestionsDiv = document.createElement('div');
            suggestionsDiv.className = 'message bot';
            suggestionsDiv.innerHTML = html;
            chatMessages.appendChild(suggestionsDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Create a chart based on suggestion
        function createChart(suggestion) {
            if (!currentData || !currentData.columns || !currentData.rows) {
                showError('Aucune donn√©e disponible pour cr√©er le graphique');
                return;
            }
            
            // Show loading indicator
            showLoading(true, `Cr√©ation du graphique ${suggestion.title}...`);
            
            // Simulate chart creation (in a real app, this would be an API call)
            setTimeout(() => {
                showLoading(false);
                
                // Create a simple chart visualization
                const chartId = 'chart-' + Date.now();
                let html = `
                    <div class="message-bubble">
                        <h5><i class="fas fa-chart-${suggestion.type === 'line' ? 'line' : suggestion.type === 'bar' ? 'bar' : 'pie'} me-2"></i> ${suggestion.title}</h5>
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>
                            Graphique cr√©√© avec succ√®s!
                        </div>
                        <div class="text-center my-3">
                            <div class="bg-light border rounded p-3">
                                <i class="fas fa-chart-${suggestion.type === 'line' ? 'line' : suggestion.type === 'bar' ? 'bar' : 'pie'}" style="font-size: 100px;"></i>
                                <div class="mt-2">Visualisation ${suggestion.type}</div>
                            </div>
                        </div>
                        <div class="text-end">
                            <button class="btn btn-sm btn-outline-primary me-2" onclick="downloadChart('${chartId}')">
                                <i class="fas fa-download me-1"></i> T√©l√©charger
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="this.closest('.message').remove()">
                                <i class="fas fa-times me-1"></i> Fermer
                            </button>
                        </div>
                    </div>
                `;
                
                // Add to chat
                const chartDiv = document.createElement('div');
                chartDiv.className = 'message bot';
                chartDiv.innerHTML = html;
                chatMessages.appendChild(chartDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 2000);
        }

        // Export data to Excel
        function exportToExcel() {
            if (!currentData || !currentData.columns || !currentData.rows) {
                showError('Aucune donn√©e √† exporter');
                return;
            }
            
            // In a real app, this would generate an actual Excel file
            addMessage(`Fichier Excel "${currentFile.name}" export√© avec succ√®s!`, false);
        }

        // Download chart
        function downloadChart(chartId) {
            // In a real app, this would download the actual chart
            addMessage(`Graphique t√©l√©charg√© avec succ√®s!`, false);
        }
    </script>
</body>
</html>